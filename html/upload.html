<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ìƒí’ˆ ë“±ë¡ - ë²ˆê°œì¥í„°</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-white text-gray-800">




<!-- ìƒë‹¨ë°” -->
  <div id="header-placeholder"></div>
  <script>
    fetch("header.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("header-placeholder").innerHTML = data;
      });
  </script>


<!-- ë“±ë¡ í¼ -->
<div class="max-w-3xl mx-auto px-4 py-12 text-sm space-y-6">
  <form id="uploadForm" enctype="multipart/form-data" class="bg-white p-6 space-y-6">


    <div class="flex justify-start mb-4">
      <label for="image" class="cursor-pointer flex flex-col items-center justify-center w-32 h-32 border rounded text-gray-400">
        <img src="https://cdn-icons-png.flaticon.com/512/685/685655.png" class="w-6 h-6" alt="ì‚¬ì§„" />
        <span class="text-xs">0/10</span>
      </label>
      <input type="file" id="image" name="image" accept="image/*" class="hidden" onchange="previewImage(event)">
      <img id="imagePreview" src="" alt="ë¯¸ë¦¬ë³´ê¸°" class="w-40 h-40 object-cover rounded hidden border ml-4">
    </div>

    <div class="space-y-2">
      <label class="block font-medium" for="title">ìƒí’ˆëª…</label>
      <input type="text" id="title" name="title" class="w-full border px-4 py-2 rounded" placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required>
    </div>

    <div class="space-y-2">
      <label class="block font-medium" for="category">ì¹´í…Œê³ ë¦¬</label>
      <select id="category" name="category" class="w-full border px-4 py-2 rounded">
        <option>ìˆ˜ì…ëª…í’ˆ</option>
        <option>íŒ¨ì…˜ì˜ë¥˜</option>
        <option>íŒ¨ì…˜ì¡í™”</option>
        <option>ë·°í‹°</option>
        <option>ì¶œì‚°/ìœ ì•„ë™</option>
        <option>ëª¨ë°”ì¼/íƒœë¸”ë¦¿</option>
      </select>
    </div>

    <div class="space-y-2">
      <label class="block font-medium" for="price">â‚© íŒë§¤ê°€ê²©</label>
      <input type="number" id="price" name="price" class="w-full border px-4 py-2 rounded" placeholder="ê°€ê²©ì„ ì…ë ¥í•˜ì„¸ìš”" min="0" required>
    </div>

    <div class="space-y-2">
      <label class="block font-medium" for="description">ìƒí’ˆ ì„¤ëª…</label>
      <textarea id="description" name="description" rows="5" class="w-full border px-4 py-2 rounded text-sm"
        placeholder="- ìƒí’ˆëª…(ë¸Œëœë“œ)\n- êµ¬ë§¤ ì‹œê¸°\n- ì‚¬ìš© ê¸°ê°„\n- í•˜ì ì—¬ë¶€ ë“±"></textarea>
    </div>

    <div class="space-y-2 p-4 rounded-md">
      <span class="block font-medium mb-2">ìƒí’ˆ ìƒíƒœ</span>
      <div class="flex gap-4">
        <button type="button" onclick="selectCondition('ì¤‘ê³ ')" id="btn-used"
          class="px-6 py-2 rounded-md border border-black bg-black text-white">ì¤‘ê³ </button>
        <button type="button" onclick="selectCondition('ìƒˆìƒí’ˆ')" id="btn-new"
          class="px-6 py-2 rounded-md border border-black bg-white text-black">ìƒˆìƒí’ˆ</button>
      </div>
      <input type="hidden" name="condition" id="condition" value="ì¤‘ê³ " />
    </div>

    <div class="text-center mt-4">
      <button type="submit" class="bg-black text-white px-20 py-2 rounded hover:bg-gray-800 transition">íŒë§¤í•˜ê¸°</button>
    </div>
  </form>
<div id="tags" class="flex flex-wrap gap-2 mt-4 px-6"></div>
</div>

<script>
document.getElementById("uploadForm").addEventListener("submit", async function (e) {
  e.preventDefault();

  const fileInput = document.getElementById("image");
  const file = fileInput.files[0];
  if (!file) return alert("ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”");
  

  const token = localStorage.getItem("token");
  const username = localStorage.getItem("username");
  if (!token || !username) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");

  const title = document.getElementById("title").value;
  const category = document.getElementById("category").value;
  const price = Number(document.getElementById("price").value);
  const description = document.getElementById("description").value || "ë‚´ìš© ì—†ìŒ";
  const condition = document.getElementById("condition").value;
  const contentType = (file.type && file.type.startsWith("image/")) ? file.type : "image/jpeg";

  const submitButton = document.querySelector("button[type='submit']");
  submitButton.disabled = true;
  submitButton.textContent = "ë“±ë¡ ì¤‘...";

  try {
    // 1ï¸âƒ£ presigned URL ìš”ì²­
    const safeFilename = encodeURIComponent(file.name);

    const uploadRes = await fetch("/api/upload", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        filename: safeFilename,
        content_type: contentType
      })
    });

    
    if (!uploadRes.ok) throw new Error("Presigned URL ìš”ì²­ ì‹¤íŒ¨");
    const uploadData = await uploadRes.json();
    const presignedUrl = uploadData.presigned_url;
    const imageUrl = presignedUrl.split("?")[0];

    console.log("ğŸ§ª presignedUrl:", presignedUrl);
    console.log("ğŸ“‚ file:", file);
    console.log("ğŸ“„ contentType:", contentType);

    
    // 2ï¸âƒ£ S3 ì—…ë¡œë“œ
    const s3Res = await fetch(presignedUrl, {
      method: "PUT",
      headers: {
        "Content-Type": contentType,
      },
      body: file
    });

    if (!s3Res.ok) {
      throw new Error("S3 ì—…ë¡œë“œ ì‹¤íŒ¨: " + s3Res.statusText);
    }

    await fetchRekognitionTags(safeFilename, username);

    // 3ï¸âƒ£ ìƒí’ˆ ë“±ë¡
    const saveRes = await fetch("/api/product", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        title,
        category,
        price,
        description,
        condition,
        filename: safeFilename,
        username,
        image_url: imageUrl
      })
    });

    const saveData = await saveRes.json();
    if (!saveRes.ok) throw new Error(saveData.message || "ìƒí’ˆ ì €ì¥ ì‹¤íŒ¨");

    alert("ìƒí’ˆ ë“±ë¡ ì™„ë£Œ!");
    window.location.href = "myshop.html";

  } catch (err) {
    alert("ì—ëŸ¬ ë°œìƒ: " + err.message);
    submitButton.disabled = false;
    submitButton.textContent = "íŒë§¤í•˜ê¸°";
  }
});

</script>


<script>
  function previewImage(event) {
    const input = event.target;
    const preview = document.getElementById('imagePreview');
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = e => {
        preview.src = e.target.result;
        preview.classList.remove('hidden');
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  function selectCondition(type) {
    const usedBtn = document.getElementById('btn-used');
    const newBtn = document.getElementById('btn-new');
    const conditionInput = document.getElementById('condition');
    conditionInput.value = type;

    if (type === 'ì¤‘ê³ ') {
      usedBtn.classList.add('bg-black', 'text-white');
      usedBtn.classList.remove('bg-white', 'text-black');
      newBtn.classList.add('bg-white', 'text-black');
      newBtn.classList.remove('bg-black', 'text-white');
    } else {
      newBtn.classList.add('bg-black', 'text-white');
      newBtn.classList.remove('bg-white', 'text-black');
      usedBtn.classList.add('bg-white', 'text-black');
      usedBtn.classList.remove('bg-black', 'text-white');
    }
  }
</script>


<!-- ìƒë‹¨ë°”/script -->
<script>
  fetch("header.html")
    .then(res => res.text())
    .then(data => {
      document.getElementById("header-placeholder").innerHTML = data;

      // âœ… í—¤ë”ê°€ ë“¤ì–´ê°„ ë‹¤ìŒì— ìš”ì†Œë“¤ ì ‘ê·¼í•´ì•¼ í•¨
      const username = localStorage.getItem("username");
      const token = localStorage.getItem("token");

      const userInfo = document.getElementById("user-info");
      const myshopLink = document.getElementById("myshop-link");
      const logoutLink = document.getElementById("logout-link");
      const loginLink = document.getElementById("login-link");
      const signupLink = document.getElementById("signup-link");

      if (token && username) {
        userInfo.textContent = `ğŸ‘¤ ${username}ë‹˜`;
        myshopLink?.classList.remove("hidden");
        logoutLink?.classList.remove("hidden");
        loginLink?.classList.add("hidden");
        signupLink?.classList.add("hidden");
      }

      logoutLink?.addEventListener("click", function (e) {
        e.preventDefault();
        localStorage.removeItem("token");
        localStorage.removeItem("username");
        location.href = "index.html";
      });
    });
</script>


<script>
  async function fetchRekognitionTags(imageName, userId) {
    const response = await fetch("/api/rekognition-tag", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ image_name: imageName, user_id: userId })
    });

    if (!response.ok) {
      console.error("íƒœê·¸ ìš”ì²­ ì‹¤íŒ¨");
      return;
    }

    const data = await response.json();
    const tagContainer = document.getElementById("tags");
    tagContainer.innerHTML = "";

    data.tags.forEach(tag => {
      const tagBox = document.createElement("div");
      tagBox.className = "bg-black text-white px-2 py-1 rounded mr-2 mb-2";
      tagBox.textContent = tag;
      tagContainer.appendChild(tagBox);
    });
  }
</script>


<!-- í‘¸í„° ìë¦¬ -->
<div id="footer-placeholder"></div>

<script>
  fetch("footer.html")
    .then(res => res.text())
    .then(data => {
      document.getElementById("footer-placeholder").innerHTML = data;
    });
</script>

</body>
</html>
