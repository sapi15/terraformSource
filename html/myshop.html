<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë‚´ ìƒì </title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- ìƒë‹¨ë°” ìë¦¬ -->
   <div id="header-placeholder"></div>


  <!-- ë³¸ë¬¸ ì‹œì‘ -->
  <div class="max-w-5xl mx-auto px-4 py-6 bg-white rounded-md shadow mt-6">
    <div class="flex gap-6 items-center">
      <div class="w-28 h-28 bg-gray-200 rounded-full flex items-center justify-center text-4xl text-gray-400">ğŸ˜Š</div>
      <div class="flex-1">
        <div class="flex items-center gap-2">
          <h1 class="text-xl font-bold"><span id="shop-username">ìƒì </span></h1>
          <span class="text-sm text-gray-500">ì‹ ë¢°ë“±ê¸‰ ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ</span>
        </div>
<div class="mt-1 text-sm text-gray-600" id="user-meta">
</div>
      </div>
      <a href="upload.html" class="bg-black text-white px-4 py-2 rounded">ìƒí’ˆ ë“±ë¡</a>
    </div>
  </div>

  <div class="max-w-5xl mx-auto px-4 mt-6 bg-white rounded shadow">
    <div class="border-b flex gap-6 text-sm font-medium px-4 pt-4">
      <button class="border-b-2 border-black pb-2">ìƒí’ˆ <span id="product-count">0</span></button>
      <button class="text-gray-400">ìƒì í›„ê¸° 0</button>
      <button class="text-gray-400">ì°œ 0</button>
      <button class="text-gray-400">íŒ”ë¡œì‰ 0</button>
      <button class="text-gray-400">íŒ”ë¡œì›Œ 0</button>
    </div>

    <div class="p-4">
      <div id="my-product-list" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </div>
  </div>

  <!-- âœ… ìŠ¤í¬ë¦½íŠ¸: header ë¡œë”© ë° ë¡œê·¸ì¸ ì²˜ë¦¬ -->
<script>
  fetch("header.html")
    .then(res => res.text())
    .then(data => {
      document.getElementById("header-placeholder").innerHTML = data;

      setTimeout(() => {
        const token = localStorage.getItem("token");

        // 1. ë¡œê·¸ì¸ í† í° ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
        if (!token) {
          alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
          location.href = "login.html";
          return;
        }

        // 2. JWT í† í°ì—ì„œ ì‚¬ìš©ì ì´ë¦„ ì¶”ì¶œ
        const username = getUsernameFromToken(token);

        // 3. ê°€ì…ì¼ ê³„ì‚° ë° ì¶œë ¥
        const joinedDaysAgo = 1377;
        const joinedDate = new Date();
        joinedDate.setDate(joinedDate.getDate() - joinedDaysAgo);
        const dateString = `${joinedDate.getFullYear()}ë…„ ${joinedDate.getMonth() + 1}ì›” ${joinedDate.getDate()}ì¼`;

        const userMeta = document.getElementById("user-meta");
        if (userMeta) {
          userMeta.innerHTML = `ê°€ì…ì¼: ${dateString} | ë“±ë¡ ìƒí’ˆìˆ˜: <span id="product-count">0</span>ê°œ`;
        }

        // 4. ì‚¬ìš©ì ê´€ë ¨ UI ì²˜ë¦¬
        const userInfo = document.getElementById("user-info");
        const myshopLink = document.getElementById("myshop-link");
        const logoutLink = document.getElementById("logout-link");
        const loginLink = document.getElementById("login-link");
        const signupLink = document.getElementById("signup-link");
        const shopNameEl = document.getElementById("shop-username");

        if (username) {
          userInfo.textContent = `ğŸ‘¤ ${username}ë‹˜`;
          shopNameEl.textContent = username;

          myshopLink?.classList.remove("hidden");
          logoutLink?.classList.remove("hidden");
          loginLink?.classList.add("hidden");
          signupLink?.classList.add("hidden");
        } else {
          userInfo.textContent = "";
          myshopLink?.classList.add("hidden");
          logoutLink?.classList.add("hidden");
          loginLink?.classList.remove("hidden");
          signupLink?.classList.remove("hidden");

          if (location.pathname.includes("myshop")) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            location.href = "login.html";
          }
        }

        // 5. ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
        logoutLink?.addEventListener("click", function (e) {
          e.preventDefault();
          localStorage.removeItem("token");
          localStorage.removeItem("username");
          location.href = "index.html";
        });

        // 6. ë‚´ ìƒí’ˆ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        fetch("/api/myshop", {
          headers: { Authorization: "Bearer " + token }
        })
          .then(res => {
            if (!res.ok) throw new Error("API ì˜¤ë¥˜: " + res.status);
            return res.json();
          })
          .then(products => {
            const container = document.getElementById("my-product-list");

            if (!products || products.length === 0) {
              container.innerHTML = "<p class='text-gray-500 text-sm text-center py-12'>ë“±ë¡í•œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>";
              return;
            }

            document.getElementById("product-count").textContent = products.length;

products.forEach(p => {
  const item = document.createElement("div");
  item.className = "border rounded shadow text-sm overflow-hidden";

  item.innerHTML = `
    <a href="product_detail.html?id=${p.id}">
      <div class="aspect-square bg-gray-100">
        <img src="${encodeURI(p.image_url)}" alt="${p.title}" class="w-full h-full object-cover" />
      </div>
      <div class="p-2 space-y-1">
        <p class="text-gray-700 font-semibold truncate">${p.title}</p>
        <p class="text-black font-bold">${Number(p.price).toLocaleString()}ì›</p>
      </div>
    </a>
  `;
  container.appendChild(item);
});
          })
          .catch(err => {
            console.error("ìƒí’ˆ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", err);
            alert("ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ ìƒíƒœë‚˜ ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
          });

      }, 100);
    });

  // JWT í† í°ì—ì„œ ì‚¬ìš©ì ì´ë¦„ ì¶”ì¶œ í•¨ìˆ˜
  function getUsernameFromToken(token) {
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      return payload.username || null;
    } catch (e) {
      return null;
    }
  }
</script>


<!-- í‘¸í„° ìë¦¬ -->
<div id="footer-placeholder"></div>

<script>
  fetch("footer.html")
    .then(res => res.text())
    .then(data => {
      document.getElementById("footer-placeholder").innerHTML = data;
    });
</script>

</body>
</html>
